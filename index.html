<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Chess Coach Pro</title>
    
    <!-- Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f0f2f5; touch-action: manipulation; font-family: 'Segoe UI', system-ui, sans-serif; }
        #board { width: 100%; max-width: 450px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Piece Theme Fix */
        .piece-417db { background-size: 100%; }

        /* Coach Box Styles */
        .coach-box {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 5px solid #cbd5e1;
            transition: all 0.3s ease;
        }
        .coach-box.best { border-left-color: #22c55e; background: #f0fdf4; }
        .coach-box.good { border-left-color: #84cc16; }
        .coach-box.mistake { border-left-color: #f59e0b; background: #fffbeb; }
        .coach-box.blunder { border-left-color: #ef4444; background: #fef2f2; }
        .coach-box.book { border-left-color: #a855f7; }

        .classification-badge {
            font-size: 0.7rem; text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em;
            padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 4px;
        }
        .bg-best { background-color: #22c55e; }
        .bg-good { background-color: #84cc16; }
        .bg-mistake { background-color: #f59e0b; }
        .bg-blunder { background-color: #ef4444; }
        .bg-book { background-color: #a855f7; }
        .bg-neutral { background-color: #94a3b8; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="pb-12">

    <!-- Navbar -->
    <nav class="bg-indigo-700 text-white p-3 shadow-md sticky top-0 z-50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-chess"></i> Chess Coach AI</h1>
            <button onclick="document.getElementById('settingsModal').classList.remove('hidden')" class="text-white hover:text-indigo-200">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto p-4 flex flex-col gap-4">

        <!-- Controls / Status -->
        <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
            <div class="flex items-center gap-3">
                <div id="turnIndicator" class="w-3 h-3 rounded-full bg-white border-2 border-black"></div>
                <span id="gameStatus" class="text-sm font-semibold text-gray-700">Load a game to start</span>
            </div>
            <div id="evalBar" class="font-mono text-sm bg-gray-800 text-yellow-400 px-2 py-1 rounded">0.00</div>
        </div>

        <!-- Board Area -->
        <div class="relative">
            <div id="board"></div>
            
            <!-- Analysis Overlay -->
            <div id="analysisOverlay" class="absolute inset-0 bg-white/95 z-20 hidden flex flex-col items-center justify-center rounded">
                <div class="text-indigo-600 font-bold mb-4 text-lg animate-pulse">Analyzing with Stockfish...</div>
                <div class="w-64 h-3 bg-gray-200 rounded-full overflow-hidden mb-2">
                    <div id="progressBar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-xs text-gray-500 font-mono">Move 0/0</div>
                <div id="geminiStatus" class="text-xs text-purple-600 mt-2 font-bold hidden">Generating Coach Commentary...</div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div class="grid grid-cols-5 gap-2">
            <button onclick="goToStart()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angles-left"></i></button>
            <button onclick="prevMove()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angle-left"></i></button>
            <button onclick="startAnalysis()" id="analyzeBtn" class="bg-indigo-600 text-white font-bold p-2 rounded shadow hover:bg-indigo-700 flex justify-center items-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Review
            </button>
            <button onclick="nextMove()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angle-right"></i></button>
            <button onclick="goToEnd()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angles-right"></i></button>
        </div>

        <!-- Coach Feedback Box -->
        <div id="coachBox" class="coach-box p-4 rounded-r-lg shadow-sm min-h-[140px] flex flex-col justify-center">
            <div id="feedbackPlaceholder" class="text-center text-gray-400 text-sm">
                <i class="fa-solid fa-comment-dots text-2xl mb-2"></i><br>
                Press "Review" to get AI coaching.
            </div>
            
            <div id="feedbackContent" class="hidden">
                <div class="flex justify-between items-start mb-2">
                    <span id="moveClassBadge" class="classification-badge bg-neutral">Neutral</span>
                    <span id="moveNumber" class="text-xs text-gray-400 font-mono">1. e4</span>
                </div>
                <div id="coachText" class="text-sm text-gray-800 leading-relaxed font-medium"></div>
                <div id="bestMoveSuggestion" class="text-xs text-gray-500 mt-3 pt-2 border-t border-gray-200">
                    <!-- Engine suggestion goes here -->
                </div>
            </div>
        </div>

        <!-- Chat / Additional Q&A -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b text-xs font-bold text-gray-500 uppercase">Ask the Coach</div>
            <div id="chatHistory" class="p-4 h-40 overflow-y-auto text-sm space-y-2">
                <div class="text-gray-400 italic text-center text-xs mt-10">Ask specific questions about the game here...</div>
            </div>
            <div class="p-2 border-t flex gap-2 bg-gray-50">
                <input type="text" id="chatInput" placeholder="Why was that move bad?" class="flex-1 border rounded px-3 py-1 text-sm focus:outline-none focus:border-indigo-500" onkeypress="handleChatEnter(event)">
                <button onclick="sendChatMessage()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <!-- Settings Modal (API Key) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Paste key here..." class="w-full border p-2 rounded text-sm">
            </div>
            <div class="flex justify-end">
                <button onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">Save</button>
            </div>
        </div>
    </div>

    <!-- PGN Load Modal -->
    <div id="pgnModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
            <h2 class="text-lg font-bold mb-2">Load Game</h2>
            <textarea id="pgnInput" class="w-full border p-2 h-40 font-mono text-xs rounded mb-4" placeholder="Paste PGN here..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('pgnModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 text-sm">Cancel</button>
                <button onclick="loadPGN()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">Load Game</button>
            </div>
        </div>
    </div>
    
    <!-- Floating Load Button -->
    <button onclick="document.getElementById('pgnModal').classList.remove('hidden')" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 z-40 transition-transform hover:scale-110">
        <i class="fa-solid fa-upload text-xl"></i>
    </button>

    <script>
        // --- CONSTANTS ---
        const STOCKFISH_URL = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
        const MODEL_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

        // --- STATE ---
        let game = new Chess();
        let board = null;
        let stockfish = null;
        let gameHistory = []; // Array of move objects
        let currentMoveIndex = -1; // -1 = Start position
        let analysisData = []; // Array storing eval & comments per move
        let geminiComments = {}; // Map: moveIndex -> "Comment string"

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initBoard();
            initStockfish();
            loadSettings();
            
            // Show settings if no key
            if (!localStorage.getItem('gemini_api_key')) {
                document.getElementById('settingsModal').classList.remove('hidden');
            }
        });

        // --- 1. BOARD & PIECES ---
        function pieceTheme(piece) {
            // FIXED: Using Chess.com CDN for reliable piece loading
            return 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/' + piece.toLowerCase() + '.png';
        }

        function initBoard() {
            board = Chessboard('board', {
                position: 'start',
                draggable: false, // Viewer mode only
                pieceTheme: pieceTheme
            });
            window.addEventListener('resize', board.resize);
        }

        // --- 2. STOCKFISH ENGINE ---
        function initStockfish() {
            const blob = new Blob([`importScripts('${STOCKFISH_URL}');`], {type: 'application/javascript'});
            stockfish = new Worker(URL.createObjectURL(blob));
            stockfish.postMessage('uci');
        }

        // --- 3. GAME LOADING ---
        function loadPGN() {
            const pgn = document.getElementById('pgnInput').value.trim();
            if (!pgn) return;

            // Attempt to clean PGN (add space after headers)
            let cleanPgn = pgn;
            if (!pgn.includes('\n\n') && pgn.includes(']')) {
                const lastBracket = pgn.lastIndexOf(']');
                cleanPgn = pgn.substring(0, lastBracket+1) + '\n\n' + pgn.substring(lastBracket+1);
            }

            const success = game.load_pgn(cleanPgn);
            if (!success) {
                // Fallback: try loading just moves
                const movesOnly = pgn.replace(/\[.*?\]/g, "").trim();
                if (!game.load_pgn(movesOnly)) {
                    alert("Invalid PGN. Please check format.");
                    return;
                }
            }

            // Extract history
            gameHistory = game.history({ verbose: true });
            
            // Reset to start
            game.reset();
            currentMoveIndex = -1;
            board.position(game.fen());
            
            updateUI();
            document.getElementById('pgnModal').classList.add('hidden');
            document.getElementById('gameStatus').innerText = "Game Loaded. Click Review.";
            document.getElementById('feedbackPlaceholder').innerHTML = '<i class="fa-solid fa-wand-magic-sparkles text-2xl mb-2 text-indigo-500"></i><br>Game Loaded.<br>Click <b>Review</b> for AI Analysis.';
        }

        // --- 4. NAVIGATION ---
        function updateUI() {
            // Update Board
            board.position(game.fen());
            
            // Turn Indicator
            const turn = game.turn();
            document.getElementById('turnIndicator').className = `w-3 h-3 rounded-full border-2 border-black ${turn === 'w' ? 'bg-white' : 'bg-black'}`;

            // Coach Box Update
            updateCoachBox();
        }

        function nextMove() {
            if (currentMoveIndex < gameHistory.length - 1) {
                currentMoveIndex++;
                game.move(gameHistory[currentMoveIndex]);
                updateUI();
            }
        }

        function prevMove() {
            if (currentMoveIndex >= 0) {
                game.undo();
                currentMoveIndex--;
                updateUI();
            }
        }

        function goToStart() {
            game.reset();
            currentMoveIndex = -1;
            updateUI();
        }

        function goToEnd() {
            while (currentMoveIndex < gameHistory.length - 1) {
                currentMoveIndex++;
                game.move(gameHistory[currentMoveIndex]);
            }
            updateUI();
        }

        // --- 5. COACH BOX LOGIC ---
        function updateCoachBox() {
            const contentDiv = document.getElementById('feedbackContent');
            const placeholder = document.getElementById('feedbackPlaceholder');
            const box = document.getElementById('coachBox');
            const badge = document.getElementById('moveClassBadge');
            const suggestionDiv = document.getElementById('bestMoveSuggestion');

            // If no analysis yet
            if (analysisData.length === 0) {
                contentDiv.classList.add('hidden');
                placeholder.classList.remove('hidden');
                box.className = 'coach-box p-4 rounded-r-lg shadow-sm min-h-[140px] flex flex-col justify-center'; // Reset style
                return;
            }

            // If at start
            if (currentMoveIndex === -1) {
                contentDiv.classList.add('hidden');
                placeholder.classList.remove('hidden');
                placeholder.innerHTML = "Start of Game";
                return;
            }

            // Show Content
            contentDiv.classList.remove('hidden');
            placeholder.classList.add('hidden');

            const data = analysisData[currentMoveIndex];
            const moveInfo = gameHistory[currentMoveIndex];
            const moveNum = Math.floor(currentMoveIndex / 2) + 1;
            const moveNotation = `${moveNum}${moveInfo.color === 'w' ? '.' : '...'} ${moveInfo.san}`;

            // 1. Classification Badge
            badge.innerText = data.classification;
            badge.className = `classification-badge bg-${data.classification.toLowerCase()}`;
            
            // 2. Box Style
            box.className = `coach-box ${data.classification.toLowerCase()} p-4 rounded-r-lg shadow-sm min-h-[140px] flex flex-col justify-center`;

            // 3. Gemini Commentary (or fallback)
            let comment = geminiComments[currentMoveIndex + 1]; // Gemini often uses 1-based indexing for moves
            if (!comment) {
                // Fallback heuristic text
                if (data.classification === "Best") comment = "Excellent find! This is the top engine move.";
                else if (data.classification === "Good") comment = "Solid move. Maintains the position.";
                else if (data.classification === "Mistake") comment = "This creates some problems. The evaluation dropped.";
                else if (data.classification === "Blunder") comment = "A critical error! This loses significant material or position.";
                else comment = "Standard book move.";
            }
            document.getElementById('coachText').innerHTML = marked.parse(comment);
            document.getElementById('moveNumber').innerText = moveNotation;

            // 4. Best Move Suggestion
            if (data.classification === "Mistake" || data.classification === "Blunder") {
                suggestionDiv.innerHTML = `Running Stockfish again would suggest: <b>${data.bestMove}</b>`;
                suggestionDiv.classList.remove('hidden');
            } else {
                suggestionDiv.classList.add('hidden');
            }

            // Update Eval Bar
            document.getElementById('evalBar').innerText = data.eval;
        }


        // --- 6. ANALYSIS PIPELINE ---
        async function startAnalysis() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { alert("Missing API Key!"); return; }

            // UI Setup
            const overlay = document.getElementById('analysisOverlay');
            overlay.classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;

            // 1. ENGINE PASS
            const tempGame = new Chess();
            let prevEval = 0.0;
            analysisData = [];

            for (let i = 0; i < gameHistory.length; i++) {
                const move = gameHistory[i];
                tempGame.move(move.san);
                
                // Update Progress
                const pct = Math.round(((i + 1) / gameHistory.length) * 100);
                document.getElementById('progressBar').style.width = pct + "%";
                document.getElementById('progressText').innerText = `Stockfish: Move ${i+1}/${gameHistory.length}`;

                // Run Engine
                const result = await runStockfish(tempGame.fen());
                
                // Classify Move
                const currentEvalVal = parseFloat(result.eval) || 0; // Handle "M3" later
                const delta = (move.color === 'w') ? (currentEvalVal - prevEval) : (prevEval - currentEvalVal);
                
                let classification = "Neutral";
                if (i < 8) classification = "Book"; // Simplify opening
                else if (delta > 0.5) classification = "Best"; // Opponent blundered? or we found gain
                else if (delta > -0.3) classification = "Good";
                else if (delta > -1.0) classification = "Mistake";
                else classification = "Blunder";

                // Override if it matched engine best move
                if (move.san === result.bestMove) classification = "Best";

                analysisData.push({
                    eval: result.eval,
                    bestMove: result.bestMove,
                    classification: classification,
                    san: move.san
                });

                prevEval = currentEvalVal;
            }

            // 2. GEMINI PASS (Get JSON comments)
            document.getElementById('geminiStatus').classList.remove('hidden');
            document.getElementById('progressText').innerTe        <!-- Actions -->
        <button onclick="startFullAnalysis()" id="analyzeBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 active:transform active:scale-95 flex items-center justify-center gap-2">
            <i class="fa-solid fa-magnifying-glass-chart"></i> Review Full Game (Pro)
        </button>

        <!-- Chat Section (Hidden until analysis is done) -->
        <div id="chatSection" class="hidden bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden flex flex-col h-[500px]">
            <div class="bg-indigo-50 p-3 border-b flex justify-between items-center">
                <span class="font-bold text-indigo-900">♟️ Coach Gemini 3</span>
                <select id="persona" class="text-xs border rounded p-1">
                    <option value="coach">Helpful Coach</option>
                    <option value="roast">Roaster</option>
                    <option value="grandmaster">Grandmaster</option>
                </select>
            </div>
            
            <div id="chatHistory" class="p-4 flex flex-col gap-2 bg-gray-50 flex-1 overflow-y-auto">
                <!-- Messages go here -->
            </div>

            <div class="p-3 bg-white border-t flex gap-2">
                <input type="text" id="userPrompt" placeholder="Ask about the game..." class="flex-1 border rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" onkeypress="handleEnter(event)">
                <button onclick="sendUserMessage()" class="bg-indigo-600 text-white px-4 rounded hover:bg-indigo-700"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <!-- PGN Modal -->
    <div id="fenModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg w-11/12 max-w-md">
            <h3 class="font-bold mb-2">Load Game</h3>
            <textarea id="pgnInput" class="w-full border p-2 h-32 text-xs font-mono mb-2" placeholder="Paste PGN here..."></textarea>
            <div class="text-red-500 text-xs mb-2 hidden" id="loadError">Invalid format</div>
            <div class="flex justify-end gap-2">
                <button onclick="closeFenDialog()" class="px-3 py-1 bg-gray-200 rounded">Cancel</button>
                <button onclick="loadPgnOrFen()" class="px-3 py-1 bg-indigo-600 text-white rounded">Load</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const STOCKFISH_URL = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
        
        // ** UPDATED TO GEMINI 3 PRO PREVIEW **
        const MODEL_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent';
        
        let board = null;
        let game = new Chess();
        let stockfish = null;
        let currentEval = "0.00";
        let engineReady = false;
        
        let chatSession = []; 

        // --- INIT ---
        const savedKey = localStorage.getItem("gemini_api_key");
        if(savedKey) document.getElementById('apiKeyInput').value = savedKey;

        document.getElementById('apiKeyInput').addEventListener('input', (e) => {
            localStorage.setItem("gemini_api_key", e.target.value);
        });

        // --- ENGINE SETUP ---
        const workerBlob = new Blob([`importScripts('${STOCKFISH_URL}');`], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(workerBlob);
        
        try {
            stockfish = new Worker(workerUrl);
            stockfish.postMessage('uci');
            
            stockfish.addEventListener('message', function(e) {
                const line = e.data;
                if(line === 'readyok') engineReady = true;
                if (!window.isAnalyzing && line.includes('cp ')) {
                   const match = line.match(/cp (-?\d+)/);
                   if (match) updateEvalBox(parseInt(match[1]));
                }
            });
        } catch (e) { console.error(e); }

        function updateEvalBox(cp) {
            const score = (game.turn() === 'w' ? cp : -cp) / 100;
            currentEval = (score > 0 ? "+" : "") + score.toFixed(2);
            document.getElementById('evalBox').innerText = currentEval;
        }

        // --- BOARD LOGIC ---
        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            stockfish.postMessage('position fen ' + game.fen());
            stockfish.postMessage('go depth 10');
        }

        function onSnapEnd() { board.position(game.fen()); }

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
        });
        window.addEventListener('resize', board.resize);

        function updateStatus() {
            let status = '';
            const moveColor = (game.turn() === 'b') ? 'Black' : 'White';
            if (game.in_checkmate()) status = 'Checkmate! ' + moveColor + ' loses.';
            else if (game.in_draw()) status = 'Draw.';
            else {
                status = moveColor + ' to move';
                if (game.in_check()) status += ' (Check)';
            }
            document.getElementById('status').innerText = status;
        }

        // --- BATCH ANALYSIS LOGIC ---
        window.isAnalyzing = false;

        async function startFullAnalysis() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) { alert("Please enter API Key first."); return; }

            window.isAnalyzing = true;
            document.getElementById('analysisOverlay').classList.remove('hidden');
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            
            const history = game.history({ verbose: true });
            const tempGame = new Chess();
            let analysisLog = "GAME ANALYSIS LOG (Format: Move# Move Eval BestMove):\n";
            
            for (let i = 0; i < history.length; i++) {
                const move = history[i];
                tempGame.move(move.san);
                const fen = tempGame.fen();
                
                const pct = Math.round(((i + 1) / history.length) * 100);
                document.getElementById('progressBar').style.width = pct + "%";
                document.getElementById('progressText').innerText = `Analyzing move ${i+1}/${history.length}...`;
                
                const result = await getEngineAnalysis(fen);
                
                const moveNum = Math.floor(i/2) + 1;
                const turn = move.color === 'w' ? '.' : '...';
                analysisLog += `${moveNum}${turn} ${move.san} {Eval: ${result.eval}, EngineRec: ${result.bestMove}}\n`;
            }

            window.isAnalyzing = false;
            document.getElementById('analysisOverlay').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('chatSection').classList.remove('hidden');
            document.getElementById('chatSection').scrollIntoView({ behavior: 'smooth' });

            initGeminiChat(analysisLog);
        }

        function getEngineAnalysis(fen) {
            return new Promise((resolve) => {
                stockfish.postMessage('stop');
                stockfish.postMessage('position fen ' + fen);
                stockfish.postMessage('go depth 12'); 

                let bestMove = "-";
                let evaluation = "0.00";

                const listener = function(e) {
                    const line = e.data;
                    if (line.includes('cp ')) {
                        const match = line.match(/cp (-?\d+)/);
                        if(match) evaluation = (parseInt(match[1]) / 100).toFixed(2);
                    } else if (line.includes('mate ')) {
                        const match = line.match(/mate (-?\d+)/);
                        if(match) evaluation = "M" + match[1];
                    }
                    if (line.startsWith('bestmove')) {
                        bestMove = line.split(' ')[1];
                        stockfish.removeEventListener('message', listener);
                        resolve({ eval: evaluation, bestMove: bestMove });
                    }
                };
                stockfish.addEventListener('message', listener);
            });
        }

        // --- GEMINI CHAT LOGIC ---
        async function initGeminiChat(analysisData) {
            const persona = document.getElementById('persona').value;
            let systemPrompt = "You are a chess coach. Use the provided Engine Analysis Log to summarize the game.";
            
            if (persona === 'roast') systemPrompt = "You are a ruthless chess roaster (like GothamChess). Roast the players based on the Engine Analysis Log.";
            if (persona === 'grandmaster') systemPrompt = "You are a GM. Analyze the game deeply using the Engine Log.";

            const initialMessage = `
            ${systemPrompt}
            
            [GAME PGN]
            ${game.pgn()}
            
            [ENGINE ANALYSIS LOG]
            ${analysisData}
            
            Please provide a summary of the game, focusing on key turning points.
            `;

            chatSession = [
                { role: "user", parts: [{ text: initialMessage }] }
            ];

            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = '';
            addMessageToUi("Analyzing game data with Gemini 3 Pro...", "ai");

            await callGeminiApi();
        }

        async function sendUserMessage() {
            const input = document.getElementById('userPrompt');
            const text = input.value.trim();
            if (!text) return;

            addMessageToUi(text, "user");
            chatSession.push({ role: "user", parts: [{ text: text }] });
            input.value = '';

            addMessageToUi("Thinking...", "ai", true); 
            await callGeminiApi();
        }

        async function callGeminiApi() {
            const apiKey = document.getElementById('apiKeyInput').value;
            const historyDiv = document.getElementById('chatHistory');

            try {
                // ** UPDATED API CALL USING HEADER AUTH **
                const response = await fetch(MODEL_ENDPOINT, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey  // Header authentication matches your curl
                    },
                    body: JSON.stringify({ contents: chatSession })
                });

                const data = await response.json();
                
                const loader = document.getElementById('loading-msg');
                if(loader) loader.remove();

                if (data.error) {
                    addMessageToUi("Error: " + data.error.message, "ai");
                    return;
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                chatSession.push({ role: "model", parts: [{ text: aiText }] });
                
                if (chatSession.length === 2) historyDiv.innerHTML = ''; 
                
                addMessageToUi(aiText, "ai");

            } catch (e) {
                addMessageToUi("Network Error: " + e.message, "ai");
            }
        }

        function addMessageToUi(text, role, isLoading = false) {
            const div = document.createElement('div');
            div.className = `msg ${role === 'user' ? 'user-msg' : 'ai-msg'} flex flex-col`;
            if (isLoading) div.id = 'loading-msg';
            
            const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            div.innerHTML = formattedText;
            
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.appendChild(div);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendUserMessage();
        }

        // --- UTILS ---
        function resetGame() {
            game.reset();
            board.start();
            updateStatus();
            document.getElementById('chatSection').classList.add('hidden');
        }
        function flipBoard() { board.flip(); }
        function undoMove() { game.undo(); board.position(game.fen()); updateStatus(); }
        function showFenDialog() { document.getElementById('fenModal').classList.remove('hidden'); }
        function closeFenDialog() { document.getElementById('fenModal').classList.add('hidden'); }
        
        function loadPgnOrFen() {
            let input = document.getElementById('pgnInput').value.trim();
            if (!input) return;
            game.reset();
            let result = game.load_pgn(input) || game.load(input);
            if (result) {
                board.position(game.fen());
                updateStatus();
                closeFenDialog();
            } else {
                document.getElementById('loadError').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
