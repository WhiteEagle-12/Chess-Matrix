<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Chess Coach Pro</title>
    
    <!-- Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background-color: #f0f2f5; touch-action: manipulation; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        /* Board Container Layout */
        .board-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 12px;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
        }

        #board { 
            flex: 1; 
            min-width: 0; 
            width: 100%; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }

        /* Eval Bar Styles */
        .eval-bar-container {
            flex: 0 0 24px;
            width: 24px;
            background-color: #374151; /* Dark gray background (Black winning) */
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column-reverse;
        }

        .eval-bar-fill {
            width: 100%;
            background-color: #ffffff; /* White foreground (White winning) */
            height: 50%;
            transition: height 0.5s ease-out;
            border-top: 1px solid #9ca3af;
        }

        .eval-score-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 9px;
            font-weight: bold;
            color: #999;
            z-index: 10;
            top: 4px;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .eval-score-text.bottom {
            top: auto;
            bottom: 4px;
            color: #ccc;
        }
        
        .piece-417db { background-size: 100%; }

        /* Coach Box Styles */
        .coach-box {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 5px solid #cbd5e1;
            transition: all 0.3s ease;
            position: relative;
        }
        .coach-box.best { border-left-color: #22c55e; background: #f0fdf4; }
        .coach-box.good { border-left-color: #84cc16; }
        .coach-box.inaccuracy { border-left-color: #facc15; background: #fefce8; } /* Yellow */
        .coach-box.mistake { border-left-color: #f97316; background: #fff7ed; } /* Orange */
        .coach-box.miss { border-left-color: #f43f5e; background: #fff1f2; } /* Pink/Red */
        .coach-box.blunder { border-left-color: #dc2626; background: #fef2f2; } /* Red */
        .coach-box.book { border-left-color: #a855f7; }

        .classification-badge {
            font-size: 0.7rem; text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em;
            padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 4px;
        }
        .bg-best { background-color: #22c55e; }
        .bg-good { background-color: #84cc16; }
        .bg-inaccuracy { background-color: #eab308; color: #fff; }
        .bg-mistake { background-color: #f97316; }
        .bg-miss { background-color: #f43f5e; }
        .bg-blunder { background-color: #dc2626; }
        .bg-book { background-color: #a855f7; }
        .bg-neutral { background-color: #94a3b8; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animating Line Indicator */
        .playing-line {
            animation: pulse-border 1s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
    </style>
</head>
<body class="pb-12">

    <!-- Navbar -->
    <nav class="bg-indigo-700 text-white p-3 shadow-md sticky top-0 z-50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-lg"><i class="fa-solid fa-chess"></i> Chess Coach AI</h1>
            <div class="flex gap-2">
                <button onclick="flipBoard()" class="text-white hover:text-indigo-200" title="Flip Board">
                    <i class="fa-solid fa-retweet"></i>
                </button>
                <button onclick="openSettings()" class="text-white hover:text-indigo-200">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto p-4 flex flex-col gap-4">

        <!-- Controls / Status -->
        <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
            <div class="flex items-center gap-3">
                <div id="turnIndicator" class="w-3 h-3 rounded-full bg-white border-2 border-black"></div>
                <span id="gameStatus" class="text-sm font-semibold text-gray-700">Load a game to start</span>
            </div>
            <div id="evalText" class="font-mono text-sm bg-gray-800 text-yellow-400 px-2 py-1 rounded">0.00</div>
        </div>

        <!-- Board Area with Eval Bar -->
        <div class="relative board-container">
            <!-- Eval Bar -->
            <div class="eval-bar-container">
                <div class="eval-score-text" id="evalBarTextTop"></div>
                <div id="visualEvalBar" class="eval-bar-fill" style="height: 50%;"></div>
                <div class="eval-score-text bottom" id="evalBarTextBottom"></div>
            </div>

            <!-- Chess Board -->
            <div id="board" class="relative"></div>
            
            <!-- Analysis Overlay -->
            <div id="analysisOverlay" class="absolute inset-0 bg-white/95 z-20 hidden flex flex-col items-center justify-center rounded">
                <button onclick="cancelAnalysis()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-2">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
                <div id="statusTitle" class="text-indigo-600 font-bold mb-4 text-lg animate-pulse">Analyzing with Stockfish...</div>
                <div class="w-64 h-3 bg-gray-200 rounded-full overflow-hidden mb-2">
                    <div id="progressBar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-xs text-gray-500 font-mono">Move 0/0</div>
                <div id="geminiStatus" class="text-xs text-purple-600 mt-2 font-bold hidden">Generating Coach Commentary...</div>
            </div>
            
            <!-- Best Line Overlay (When animating) -->
            <div id="bestLineOverlay" class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded hidden pointer-events-none z-10">
                Playing Best Line...
            </div>
        </div>

        <!-- Navigation Bar -->
        <div class="flex flex-col gap-2">
            <!-- Main Nav -->
            <div class="grid grid-cols-5 gap-2">
                <button onclick="goToStart()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angles-left"></i></button>
                <button onclick="prevMove()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angle-left"></i></button>
                
                <!-- Review Button Group -->
                <div class="relative group">
                    <button onclick="startAnalysis()" id="analyzeBtn" class="w-full h-full bg-indigo-600 text-white font-bold p-2 rounded shadow hover:bg-indigo-700 flex justify-center items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Review
                    </button>
                </div>

                <button onclick="nextMove()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angle-right"></i></button>
                <button onclick="goToEnd()" class="bg-white p-2 rounded shadow text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-angles-right"></i></button>
            </div>
            
            <!-- Analysis Options -->
            <div class="flex justify-end items-center gap-2 text-xs text-gray-600">
                <span class="font-bold">Coach Focus:</span>
                <select id="analysisFocus" class="border rounded p-1 bg-white">
                    <option value="both">Both Sides</option>
                    <option value="w">White (My Moves)</option>
                    <option value="b">Black (My Moves)</option>
                </select>
            </div>
        </div>

        <!-- Coach Feedback Box -->
        <div id="coachBox" class="coach-box p-4 rounded-r-lg shadow-sm min-h-[140px] flex flex-col justify-center">
            <div id="feedbackPlaceholder" class="text-center text-gray-400 text-sm">
                <i class="fa-solid fa-comment-dots text-2xl mb-2"></i><br>
                Press "Review" to get AI coaching.
            </div>
            
            <div id="feedbackContent" class="hidden">
                <div class="flex justify-between items-start mb-2">
                    <span id="moveClassBadge" class="classification-badge bg-neutral">Neutral</span>
                    <span id="moveNumber" class="text-xs text-gray-400 font-mono">1. e4</span>
                </div>
                <div id="coachText" class="text-sm text-gray-800 leading-relaxed font-medium"></div>
                
                <!-- Engine Suggestions -->
                <div id="bestMoveSuggestion" class="hidden mt-3 pt-2 border-t border-gray-200/50">
                    <div class="text-xs text-gray-500 flex justify-between items-center">
                         <span>Best was: <b id="bestMoveText"></b></span>
                         <button onclick="playBestLine()" id="showLineBtn" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold hover:bg-indigo-200 transition-colors">
                            <i class="fa-solid fa-play"></i> Show Best Line
                         </button>
                    </div>
                    <div id="bestLineText" class="text-[10px] text-gray-400 font-mono mt-1 truncate"></div>
                </div>
            </div>
        </div>

        <!-- Chat / Additional Q&A -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b text-xs font-bold text-gray-500 uppercase">Ask the Coach</div>
            <div id="chatHistory" class="p-4 h-40 overflow-y-auto text-sm space-y-2">
                <div class="text-gray-400 italic text-center text-xs mt-10">Ask specific questions about the game here...</div>
            </div>
            <div class="p-2 border-t flex gap-2 bg-gray-50">
                <input type="text" id="chatInput" placeholder="Why was that move bad?" class="flex-1 border rounded px-3 py-1 text-sm focus:outline-none focus:border-indigo-500" onkeypress="handleChatEnter(event)">
                <button onclick="sendChatMessage()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <!-- Settings Modal (API Key) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Paste key here..." class="w-full border p-2 rounded text-sm">
                <p class="text-xs text-gray-400 mt-1">Key is saved in browser storage.</p>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 text-sm">Close</button>
                <button id="saveKeyBtn" onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">Save Key</button>
            </div>
        </div>
    </div>

    <!-- PGN Load Modal -->
    <div id="pgnModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
            <h2 class="text-lg font-bold mb-2">Load Game</h2>
            <textarea id="pgnInput" class="w-full border p-2 h-40 font-mono text-xs rounded mb-4" placeholder="Paste PGN here..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('pgnModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 text-sm">Cancel</button>
                <button id="loadPgnBtn" onclick="loadPGN()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">Load Game</button>
            </div>
        </div>
    </div>
    
    <!-- Floating Load Button -->
    <button onclick="document.getElementById('pgnModal').classList.remove('hidden')" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 z-40 transition-transform hover:scale-110">
        <i class="fa-solid fa-upload text-xl"></i>
    </button>

    <script>
        // --- CONSTANTS ---
        const STOCKFISH_URL = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
        const MODEL_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

        // --- STATE ---
        let game = new Chess();
        let board = null;
        let stockfish = null;
        let gameHistory = []; 
        let currentMoveIndex = -1; 
        let analysisData = []; // Stores eval, classification, PV (line)
        let geminiComments = {}; 
        let isAnalyzing = false;
        let isPlayingLine = false;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initBoard();
            initStockfish();
            loadSettings();
            
            if (!localStorage.getItem('gemini_api_key')) {
                openSettings();
            }

            setTimeout(() => {
                if(board) board.resize();
            }, 300);
        });

        // --- 1. BOARD & PIECES ---
        function pieceTheme(piece) {
            return 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/' + piece.toLowerCase() + '.png';
        }

        function initBoard() {
            board = Chessboard('board', {
                position: 'start',
                draggable: false, 
                pieceTheme: pieceTheme
            });
            window.addEventListener('resize', board.resize);
        }
        
        function flipBoard() {
            if(board) board.flip();
        }

        // --- 2. STOCKFISH ENGINE ---
        function initStockfish() {
            try {
                const blob = new Blob([`importScripts('${STOCKFISH_URL}');`], {type: 'application/javascript'});
                stockfish = new Worker(URL.createObjectURL(blob));
                stockfish.postMessage('uci');
            } catch (e) {
                console.error("Stockfish init failed:", e);
            }
        }

        // --- 3. GAME LOADING ---
        function loadPGN() {
            const btn = document.getElementById('loadPgnBtn');
            const originalText = btn.innerText;
            btn.innerText = "Loading...";

            setTimeout(() => {
                const pgn = document.getElementById('pgnInput').value.trim();
                if (!pgn) {
                    btn.innerText = originalText;
                    return;
                }

                try {
                    let success = game.load_pgn(pgn);
                    
                    if (!success) {
                        let cleanPgn = pgn.replace(/\{.*?\}/g, '').replace(/\$\d+/g, '');
                        if (!game.load_pgn(cleanPgn)) {
                            const movesOnly = pgn.replace(/\[.*?\]/g, "").trim();
                            if (!game.load_pgn(movesOnly)) {
                                throw new Error("Parse failed");
                            }
                        }
                    }

                    gameHistory = game.history({ verbose: true });
                    game.reset();
                    currentMoveIndex = -1;
                    board.position(game.fen());
                    board.orientation('white'); 
                    
                    analysisData = [];
                    geminiComments = {};
                    
                    updateUI();
                    document.getElementById('pgnModal').classList.add('hidden');
                    document.getElementById('gameStatus').innerText = "Game Loaded. Click Review.";
                    document.getElementById('feedbackPlaceholder').innerHTML = '<i class="fa-solid fa-wand-magic-sparkles text-2xl mb-2 text-indigo-500"></i><br>Game Loaded.<br>Click <b>Review</b> for AI Analysis.';
                    document.getElementById('pgnInput').value = ''; 
                    
                    setTimeout(() => board.resize(), 100);

                } catch (e) {
                    alert("Invalid PGN. Please paste a standard PGN format.");
                    console.error(e);
                } finally {
                    btn.innerText = originalText;
                }
            }, 50);
        }

        // --- 4. NAVIGATION ---
        function updateUI() {
            if(isPlayingLine) return; 
            board.position(game.fen());
            
            const turn = game.turn();
            document.getElementById('turnIndicator').className = `w-3 h-3 rounded-full border-2 border-black ${turn === 'w' ? 'bg-white' : 'bg-black'}`;

            updateCoachBox();
            updateEvalBar();
        }

        function nextMove() {
            if(isPlayingLine) return;
            if (currentMoveIndex < gameHistory.length - 1) {
                currentMoveIndex++;
                game.move(gameHistory[currentMoveIndex]);
                updateUI();
            }
        }

        function prevMove() {
            if(isPlayingLine) return;
            if (currentMoveIndex >= 0) {
                game.undo();
                currentMoveIndex--;
                updateUI();
            }
        }

        function goToStart() {
            if(isPlayingLine) return;
            game.reset();
            currentMoveIndex = -1;
            updateUI();
        }

        function goToEnd() {
            if(isPlayingLine) return;
            while (currentMoveIndex < gameHistory.length - 1) {
                currentMoveIndex++;
                game.move(gameHistory[currentMoveIndex]);
            }
            updateUI();
        }

        // --- 5. COACH BOX & EVAL LOGIC ---
        function updateEvalBar() {
            let evalVal = 0.00;
            const barFill = document.getElementById('visualEvalBar');
            const evalText = document.getElementById('evalText');
            
            if (currentMoveIndex >= 0 && analysisData[currentMoveIndex]) {
                const data = analysisData[currentMoveIndex];
                
                if (typeof data.eval === 'string' && data.eval.startsWith('M')) {
                    const mateIn = parseInt(data.eval.substring(1));
                    evalVal = mateIn > 0 ? 10 : -10; 
                    evalText.innerText = `M${Math.abs(mateIn)}`;
                } else {
                    evalVal = parseFloat(data.eval);
                    evalText.innerText = Math.abs(evalVal).toFixed(2);
                }
            } else {
                evalText.innerText = "0.30";
                evalVal = 0.3;
            }

            const clampedEval = Math.max(-5, Math.min(5, evalVal));
            const percentage = 50 + (clampedEval * 10); 
            
            barFill.style.height = `${percentage}%`;
            
            if (percentage > 90) evalText.style.color = '#333'; 
            else if (percentage < 10) evalText.style.color = '#fff'; 
            else evalText.style.color = '#999'; 
        }

        function updateCoachBox() {
            const contentDiv = document.getElementById('feedbackContent');
            const placeholder = document.getElementById('feedbackPlaceholder');
            const box = document.getElementById('coachBox');
            const badge = document.getElementById('moveClassBadge');
            const suggestionDiv = document.getElementById('bestMoveSuggestion');
            const bestMoveText = document.getElementById('bestMoveText');
            const showLineBtn = document.getElementById('showLineBtn');
            const bestLineText = document.getElementById('bestLineText');

            if (analysisData.length === 0) {
                contentDiv.classList.add('hidden');
                placeholder.classList.remove('hidden');
                box.className = 'coach-box p-4 rounded-r-lg shadow-sm min-h-[140px] flex flex-col justify-center'; 
                return;
            }

            if (currentMoveIndex === -1) {
                contentDiv.classList.add('hidden');
                placeholder.classList.remove('hidden');
                placeholder.innerHTML = "Start of Game";
                return;
            }

            contentDiv.classList.remove('hidden');
            placeholder.classList.add('hidden');

            const data = analysisData[currentMoveIndex];
            const moveInfo = gameHistory[currentMoveIndex];
            const moveNum = Math.floor(currentMoveIndex / 2) + 1;
            const moveNotation = `${moveNum}${moveInfo.color === 'w' ? '.' : '...'} ${moveInfo.san}`;

            badge.innerText = data.classification;
            badge.className = `classification-badge bg-${data.classification.toLowerCase()}`;
            box.className = `coach-box ${data.classification.toLowerCase()} p-4 rounded-r-lg shadow-sm min-h-[140px] flex flex-col justify-center`;

            let comment = geminiComments[currentMoveIndex + 1]; 
            if (!comment) {
                if (data.classification === "Best") comment = "Excellent find! This is the top engine move.";
                else if (data.classification === "Good") comment = "Solid move. Maintains the position.";
                else if (data.classification === "Inaccuracy") comment = "Slight inaccuracy. There was a more precise move.";
                else if (data.classification === "Mistake") comment = "This creates some problems. The evaluation dropped.";
                else if (data.classification === "Miss") comment = "Missed opportunity to gain a significant advantage.";
                else if (data.classification === "Blunder") comment = "A critical error! This loses significant material or position.";
                else comment = "Standard book move.";
            }
            document.getElementById('coachText').innerHTML = marked.parse(comment);
            document.getElementById('moveNumber').innerText = moveNotation;

            const needsSuggestion = ["Inaccuracy", "Mistake", "Miss", "Blunder"].includes(data.classification);
            
            if (needsSuggestion && data.bestMoveSan) {
                suggestionDiv.classList.remove('hidden');
                bestMoveText.innerText = data.bestMoveSan;
                
                if (data.pvSan && data.pvSan.length > 0) {
                    showLineBtn.classList.remove('hidden');
                    showLineBtn.onclick = () => playBestLine(data.pv, data.fenBefore);
                    bestLineText.innerText = "Line: " + data.pvSan;
                } else {
                    showLineBtn.classList.add('hidden');
                    bestLineText.innerText = "";
                }
            } else {
                suggestionDiv.classList.add('hidden');
            }
        }

        // --- 6. ANALYSIS PIPELINE ---
        function cancelAnalysis() {
            isAnalyzing = false;
            document.getElementById('analysisOverlay').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = false;
        }
        
        // Helper: Convert UCI string (e2e4 g8f6) to SAN string (1. e4 Nf6 2...)
        function uciToSan(fen, pvString) {
            if (!pvString) return "";
            
            // Safe Move Count Parsing
            let moveCount = 1;
            const parts = fen.split(' ');
            if (parts.length >= 6) {
                moveCount = parseInt(parts[5]);
            }
            
            const temp = new Chess(fen);
            const moves = pvString.split(' ');
            let sanStr = "";
            
            for (let i = 0; i < moves.length; i++) {
                const m = moves[i];
                const from = m.substring(0, 2);
                const to = m.substring(2, 4);
                const promotion = m.length > 4 ? m.substring(4, 5) : undefined;
                
                // Add move number if white or start
                if (temp.turn() === 'w') {
                    sanStr += `${moveCount}. `;
                } else if (i === 0) {
                     sanStr += `${moveCount}... `;
                }

                const moveObj = temp.move({ from, to, promotion });
                if (moveObj) {
                    sanStr += moveObj.san + " ";
                    if (temp.turn() === 'w') moveCount++;
                } else {
                    break;
                }
            }
            return sanStr.trim();
        }

        async function startAnalysis() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { 
                alert("Please add your Gemini API Key in settings first."); 
                openSettings();
                return; 
            }
            
            const focus = document.getElementById('analysisFocus').value; 

            isAnalyzing = true;
            const overlay = document.getElementById('analysisOverlay');
            overlay.classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('statusTitle').innerText = "Analyzing with Stockfish...";
            document.getElementById('geminiStatus').classList.add('hidden');
            document.getElementById('progressBar').style.width = "0%";
            document.getElementById('progressBar').className = "h-full bg-indigo-500 transition-all duration-300";

            const tempGame = new Chess();
            analysisData = [];

            try {
                // 1. ENGINE PASS
                for (let i = 0; i < gameHistory.length; i++) {
                    if (!isAnalyzing) return; 

                    const move = gameHistory[i];
                    
                    const pct = Math.round(((i + 1) / gameHistory.length) * 100);
                    document.getElementById('progressBar').style.width = pct + "%";
                    document.getElementById('progressText').innerText = `Stockfish: Move ${i+1}/${gameHistory.length}`;

                    // A. PRE-MOVE ANALYSIS
                    const fenBefore = tempGame.fen();
                    const preMoveResult = await runStockfish(fenBefore);
                    
                    let bestMoveSan = preMoveResult.bestMove;
                    // Smart conversion of PV to SAN
                    let bestLineSan = "";
                    
                    if(preMoveResult.bestMove && preMoveResult.bestMove !== '-') {
                        // Get immediate best move SAN
                        const from = preMoveResult.bestMove.substring(0,2);
                        const to = preMoveResult.bestMove.substring(2,4);
                        const promotion = preMoveResult.bestMove.length > 4 ? preMoveResult.bestMove.substring(4,5) : undefined;
                        
                        // We use a clone to check move validity without messing up tempGame yet
                        const checkGame = new Chess(fenBefore);
                        const moveObj = checkGame.move({ from, to, promotion });
                        if(moveObj) bestMoveSan = moveObj.san;
                        
                        // Convert Full PV to SAN for display/AI
                        if (preMoveResult.pv) {
                            bestLineSan = uciToSan(fenBefore, preMoveResult.pv);
                        }
                    }

                    let currentEvalBefore = parseEval(preMoveResult.eval, tempGame.turn());

                    // B. MAKE ACTUAL MOVE
                    tempGame.move(move.san);
                    
                    // C. POST-MOVE ANALYSIS
                    const postMoveResult = await runStockfish(tempGame.fen());
                    let currentEvalAfter = parseEval(postMoveResult.eval, tempGame.turn());
                    
                    let delta = 0;
                    if (move.color === 'w') {
                        delta = currentEvalAfter - currentEvalBefore;
                    } else {
                        delta = currentEvalBefore - currentEvalAfter; 
                    }

                    let classification = "Neutral";
                    if (i < 8 && Math.abs(delta) > -0.3) classification = "Book"; 
                    else if (delta > 0.3) classification = "Best"; 
                    else if (delta > -0.2) classification = "Good";
                    else if (delta > -0.6) classification = "Inaccuracy"; 
                    else if (delta > -1.5) classification = "Mistake"; 
                    else if (delta > -3.0) classification = "Miss"; 
                    else classification = "Blunder"; 

                    if (move.san === bestMoveSan) classification = "Best";
                    
                    analysisData.push({
                        eval: currentEvalAfter.toFixed(2), 
                        bestMove: preMoveResult.bestMove,
                        bestMoveSan: bestMoveSan,
                        pv: preMoveResult.pv, 
                        pvSan: bestLineSan, // Store the readable line
                        san: move.san,
                        color: move.color,
                        classification: classification,
                        fen: tempGame.fen(),
                        fenBefore: fenBefore
                    });
                }

                // 2. GEMINI PASS
                if (!isAnalyzing) return;
                
                document.getElementById('statusTitle').innerText = "Asking Coach...";
                document.getElementById('geminiStatus').classList.remove('hidden');
                document.getElementById('progressText').innerText = "AI is writing commentary...";
                document.getElementById('progressBar').className = "h-full bg-purple-500 transition-all duration-300 animate-pulse";
                
                await getGeminiCommentary(apiKey, focus);

            } catch (err) {
                console.error("Analysis failed:", err);
                alert("An error occurred during analysis: " + err.message);
            } finally {
                overlay.classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
                isAnalyzing = false;
                
                if (analysisData.length > 0) {
                   if(currentMoveIndex === -1) nextMove(); 
                   else updateUI();
                }
            }
        }

        // --- 7. PLAY BEST LINE FEATURE ---
        async function playBestLine(pv, startFen) {
            if(!pv || isPlayingLine) return;
            
            isPlayingLine = true;
            document.getElementById('board').classList.add('playing-line');
            document.getElementById('bestLineOverlay').classList.remove('hidden');
            
            const ghostGame = new Chess(startFen);
            const moves = pv.split(' ');
            
            board.position(startFen);
            await new Promise(r => setTimeout(r, 500));

            for (let moveStr of moves) {
                if (!isPlayingLine) break; 
                
                const from = moveStr.substring(0,2);
                const to = moveStr.substring(2,4);
                const promotion = moveStr.length > 4 ? moveStr.substring(4,5) : 'q';
                
                const move = ghostGame.move({ from, to, promotion });
                if(!move) break; 
                
                board.position(ghostGame.fen());
                await new Promise(r => setTimeout(r, 800));
            }
            
            document.getElementById('board').classList.remove('playing-line');
            document.getElementById('bestLineOverlay').classList.add('hidden');
            isPlayingLine = false;
            board.position(game.fen());
        }

        // --- HELPERS ---
        function parseEval(evalStr, turn) {
            if (typeof evalStr === 'string' && evalStr.startsWith('M')) {
                return parseFloat(evalStr.replace('M', '')) > 0 ? 100 : -100; 
            }
            return parseFloat(evalStr);
        }

        function runStockfish(fen) {
            return new Promise(resolve => {
                if (!stockfish) initStockfish();

                const timeoutId = setTimeout(() => {
                    resolve({ eval: "0.00", bestMove: "-", pv: "" }); 
                }, 3000); 

                stockfish.postMessage('stop');
                stockfish.postMessage('position fen ' + fen);
                stockfish.postMessage('go depth 12'); 

                let best = "-";
                let evalScore = "0.00";
                let pvLine = "";

                const listener = (e) => {
                    const line = e.data;
                    
                    if (line.includes(' pv ')) {
                        const parts = line.split(' pv ');
                        if(parts[1]) pvLine = parts[1];
                    }

                    if (line.includes('cp ')) {
                        const match = line.match(/cp (-?\d+)/);
                        if(match) {
                            let score = parseInt(match[1]) / 100;
                            const side = fen.split(' ')[1];
                            if (side === 'b') score = -score;
                            evalScore = score.toFixed(2);
                        }
                    }
                    if (line.includes('mate ')) {
                        const match = line.match(/mate (-?\d+)/);
                        if(match) {
                            let mateIn = parseInt(match[1]);
                            const side = fen.split(' ')[1];
                            if (side === 'b') mateIn = -mateIn;
                            evalScore = "M" + mateIn;
                        }
                    }
                    if (line.startsWith('bestmove')) {
                        clearTimeout(timeoutId); 
                        best = line.split(' ')[1]; 
                        stockfish.removeEventListener('message', listener);
                        resolve({ eval: evalScore, bestMove: best, pv: pvLine }); 
                    }
                };
                stockfish.addEventListener('message', listener);
            });
        }

        // --- 8. GEMINI API ---
        async function getGeminiCommentary(apiKey, focus) {
            let gameLog = "";
            analysisData.forEach((d, i) => {
                const isRelevant = focus === 'both' || focus === d.color;
                
                if(isRelevant) {
                    if(["Mistake", "Blunder", "Miss", "Inaccuracy", "Best"].includes(d.classification) || i % 5 === 0) {
                        // Use SAN PV instead of raw PV
                        const context = `\n   FEN: ${d.fen}\n   Best Line (Recommended): ${d.pvSan}`;
                        gameLog += `Move ${i+1} (${d.color}): ${d.san} (Eval: ${d.eval}, Class: ${d.classification}, Better: ${d.bestMoveSan})${context}\n`;
                    }
                } else {
                     gameLog += `Move ${i+1} (${d.color}): ${d.san} (Eval: ${d.eval})\n`;
                }
            });

            if(!gameLog) gameLog = "Game was very balanced.";
            
            let focusInstruction = "Analyze both sides equally.";
            if(focus === 'w') focusInstruction = "Player is WHITE. Focus entirely on White's decisions.";
            if(focus === 'b') focusInstruction = "Player is BLACK. Focus entirely on Black's decisions.";

            const prompt = `
            You are a Grandmaster Chess Coach. 
            ${focusInstruction}

            **INSTRUCTIONS:**
            1. **CLASSIFICATION FEEDBACK:**
               - **"Inaccuracy" / "Mistake":** Explain the strategic error.
               - **"Miss":** HIGHLIGHT what was missed.
               - **"Blunder":** Be strict.
            
            2. **NARRATE THE BEST LINE (PV):**
               - I have converted the computer line to readable notation (e.g. 1. e4 e5).
               - **DO NOT just list the moves.** - **NARRATE the logic.**
               - BAD: "The best line is Nf3 d5 g3."
               - GOOD: "The engine suggests developing the Knight to f3 to control the center, then fianchettoing the Bishop."

            **Game Data:**
            ${gameLog}

            **Output JSON Format:**
            {
                "12": "Mistake. You allowed the Knight to outpost. Better was playing c4 to challenge the center immediately."
            }
            `;

            try {
                const response = await fetch(MODEL_ENDPOINT + `?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { response_mime_type: "application/json" }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const jsonText = data.candidates[0].content.parts[0].text;
                geminiComments = JSON.parse(jsonText);
                
            } catch (e) {
                console.error("Gemini Error:", e);
                geminiComments = { 1: "Analysis complete." };
            }
        }

        // --- 9. CHAT ---
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value;
            const apiKey = localStorage.getItem('gemini_api_key');
            
            if(!apiKey) { alert("Please save API key first"); return; }
            if(!text) return;

            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML += `<div class="bg-indigo-50 p-2 rounded mb-2 text-right"><b>You:</b> ${text}</div>`;
            input.value = "";
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const prompt = `
            Context: Chess Game PGN: ${game.pgn()}
            Current Board FEN: ${game.fen()}
            Current Move Index: ${currentMoveIndex} (Move ${Math.floor(currentMoveIndex/2)+1})
            User Question: ${text}
            
            Answer as a Chess Coach. Use the FEN to describe specific piece locations.
            `;

            try {
                const response = await fetch(MODEL_ENDPOINT + `?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                chatHistory.innerHTML += `<div class="text-left mb-2 text-gray-700"><b>Coach:</b> ${marked.parse(reply)}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;

            } catch (e) {
                chatHistory.innerHTML += `<div class="text-red-500 text-xs">Error contacting Coach. Check API Key.</div>`;
            }
        }

        function handleChatEnter(e) { if(e.key === 'Enter') sendChatMessage(); }

        // --- SETTINGS ---
        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(!key) { alert("Please enter a key."); return; }
            localStorage.setItem('gemini_api_key', key);
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function loadSettings() {
            const key = localStorage.getItem('gemini_api_key');
            if(key) document.getElementById('apiKeyInput').value = key;
        }
        
        function openSettings() {
            loadSettings();
            document.getElementById('settingsModal').classList.remove('hidden');
        }

    </script>
</body>
</html>
